(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{4985:(e,s,t)=>{"use strict";t.d(s,{J:()=>c,UserProvider:()=>i});var r=t(5155),n=t(2115),l=t(8032);let a=(0,n.createContext)(void 0),i=e=>{let{children:s}=e,[t,i]=(0,n.useState)(null);return(0,n.useEffect)(()=>{(null==t?void 0:t.id)&&(l.s.emit("register",t.id),console.log("\uD83D\uDCE1 Registered user:",t.id))},[t]),(0,r.jsx)(a.Provider,{value:{user:t,setUser:i},children:s})},c=()=>{let e=(0,n.useContext)(a);if(!e)throw Error("useUser must be used within UserProvider");return e}},5340:()=>{},6174:(e,s,t)=>{Promise.resolve().then(t.bind(t,9778))},8032:(e,s,t)=>{"use strict";t.d(s,{s:()=>r});let r=(0,t(9829).io)("http://localhost:3001",{transports:["websocket"],autoConnect:!0})},9778:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>v});var r=t(5155),n=t(2115),l=t(5993),a=t(6651),i=t(5626),c=t(9141),d=t(890),o=t(17),u=t(8085),m=t(4662),x=t(2619),h=t.n(x),g=t(4985),f=t(530),j=t.n(f),p=t(8032);let b=function(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=new Audio(e);return t.loop=s,t.play().catch(()=>{}),t},y=e=>{e&&(e.pause(),e.currentTime=0)};function v(){let{user:e}=(0,g.J)(),[s,t]=(0,n.useState)([]),[x,f]=(0,n.useState)(null),[v,N]=(0,n.useState)([]),[w,k]=(0,n.useState)(""),[C,A]=(0,n.useState)(""),D=(0,n.useRef)(null),I=(0,n.useRef)(null),[E,S]=(0,n.useState)(null),[O,T]=(0,n.useState)("idle"),[P,U]=(0,n.useState)(null),[M,_]=(0,n.useState)(null),[F,H]=(0,n.useState)(!1);async function K(){try{let s=await fetch("".concat("http://localhost:3001","/messages/").concat(x.roomId),{credentials:"include"}),t=(await s.json()).messages;N(t.map(s=>({id:s.messageId,text:s.text,sender:s.senderId,time:new Date(s.createdAt),isOwn:s.senderId===e.id})))}catch(e){console.error("Lỗi khi tải tin nhắn:",e)}}(0,n.useEffect)(()=>{var e;null==(e=I.current)||e.scrollIntoView({behavior:"smooth"})},[v]),(0,n.useEffect)(()=>{!async function(){try{let e=await fetch("".concat("http://localhost:3001","/chats"),{method:"GET",credentials:"include"}),s=(await e.json()).map(e=>({...e,lastTime:new Date(e.lastTime)}));t(s)}catch(e){console.error("Lỗi khi tải danh s\xe1ch chat:",e)}}()},[]),(0,n.useEffect)(()=>{if(!x)return;K(),p.s.emit("joinRoom",x.roomId);let s=s=>{s.roomId===x.roomId&&N(t=>[...t,{id:s.messageId,text:s.text,sender:s.sender,time:new Date(s.createdAt),isOwn:s.sender===e.id}])};return p.s.on("newMessage",s),()=>p.s.off("newMessage",s)},[x]);let L=()=>{if(!w.trim()||!x)return;let s={roomId:x.roomId,sender:e.id,receiver:x.otherUserId,text:w.trim()};p.s.emit("sendMessage",s),k("")};(0,n.useEffect)(()=>(p.s.on("incoming-call",e=>{let{from:s,offer:t}=e;console.log("\uD83D\uDCF2 Incoming call from:",s),S({from:s,offer:t}),U(s),H(!0),T("ringing"),_(b("/sounds/incoming.mp3",!0))}),()=>p.s.off("incoming-call")),[]);let R=()=>{P&&(console.log("\uD83D\uDCF4 Kết th\xfac cuộc gọi với:",P),p.s.emit("end-call",{to:P}),y(M),b("/sounds/end.mp3"),T("ended"),H(!1),D.current&&(D.current.destroy(),D.current=null))};(0,n.useEffect)(()=>(p.s.on("call-answered",e=>{let{answer:s}=e;D.current&&D.current.signal(s),y(M),T("connected"),H(!0)}),p.s.on("call-rejected",()=>{y(M),b("/sounds/rejected.mp3"),T("ended"),H(!1),D.current&&D.current.destroy()}),p.s.on("call-ended",()=>{y(M),b("/sounds/end.mp3"),T("ended"),H(!1),D.current&&D.current.destroy()}),()=>{p.s.off("call-answered"),p.s.off("call-rejected"),p.s.off("call-ended")}),[M]);let G=s.filter(e=>{var s;return null==(s=e.title)?void 0:s.toLowerCase().includes(C.toLowerCase())});return(0,r.jsxs)("div",{className:"flex h-[calc(100dvh-70px)] bg-gray-100 overflow-hidden",children:[(0,r.jsxs)("div",{className:"".concat(x?"hidden md:flex":"flex"," md:w-96 flex-col bg-white border-r border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex-shrink-0 p-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsx)("h1",{className:"text-xl font-bold text-gray-800",children:"Tin nhắn"}),(0,r.jsx)(h(),{href:"/",className:"text-gray-500 hover:text-indigo-600",children:(0,r.jsx)(l.A,{className:"w-5 h-5"})})]}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(a.A,{className:"absolute left-3 top-2.5 w-4 h-4 text-gray-400"}),(0,r.jsx)("input",{type:"text",placeholder:"T\xecm kiếm tin nhắn...",value:C,onChange:e=>A(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:G.length>0?G.map(e=>{var s;return(0,r.jsx)("div",{onClick:()=>{f(e),t(s=>s.map(s=>s.id===e.id?{...s,unread:0}:s))},className:"p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 transition ".concat((null==x?void 0:x.id)===e.id?"bg-indigo-50":""),children:(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold",children:null==e||null==(s=e.title)?void 0:s.charAt(0)}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex justify-between items-baseline",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 truncate",children:e.title}),(0,r.jsx)("span",{className:"text-xs text-gray-500 ml-2",children:(0,m.GP)(e.lastTime,"HH:mm")})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600 truncate",children:e.lastMessage})]}),e.unread>0&&(0,r.jsx)("div",{className:"w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-medium",children:e.unread})]})},e.id)}):(0,r.jsx)("div",{className:"p-8 text-center text-gray-500",children:(0,r.jsx)("p",{children:"Kh\xf4ng c\xf3 tin nhắn n\xe0o"})})})]}),(0,r.jsx)("div",{className:"flex-1 flex flex-col bg-gray-50 overflow-hidden",children:x?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("button",{onClick:()=>f(null),className:"md:hidden text-gray-600 hover:text-indigo-600",children:(0,r.jsx)(i.A,{className:"w-5 h-5"})}),(0,r.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold",children:x.title.charAt(0)}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"font-semibold text-gray-900",children:x.roomTitle}),(0,r.jsx)("p",{className:"text-xs text-green-600",children:"Đang hoạt động"})]})]}),(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)("button",{className:"p-2 text-gray-600 hover:bg-gray-100 rounded-full",onClick:()=>{var e;return e=x.otherUserId,void navigator.mediaDevices.getUserMedia({audio:!0}).then(s=>{let t=new(j())({initiator:!0,trickle:!1,stream:s,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:relay1.expressturn.com:3478",username:"efree",credential:"efree"}]}});U(e),D.current=t,T("ringing"),H(!0),_(b("/sounds/ringing.mp3",!0)),t.on("signal",s=>{p.s.emit("call-user",{to:e,offer:s})}),t.on("stream",e=>{let s=document.getElementById("remoteAudio");s&&(s.srcObject=e,s.play().catch(e=>console.error("⚠️ Audio play failed:",e)))})})},children:(0,r.jsx)(c.A,{className:"w-5 h-5"})}),(0,r.jsx)("button",{className:"p-2 text-gray-600 hover:bg-gray-100 rounded-full",children:(0,r.jsx)(d.A,{className:"w-5 h-5"})}),(0,r.jsx)("button",{className:"p-2 text-gray-600 hover:bg-gray-100 rounded-full",children:(0,r.jsx)(o.A,{className:"w-5 h-5"})}),(0,r.jsx)("audio",{id:"remoteAudio",autoPlay:!0,controls:!0,className:"hidden"})]})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[v.map(e=>(0,r.jsx)("div",{className:"flex ".concat(e.isOwn?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ".concat(e.isOwn?"bg-indigo-600 text-white":"bg-white text-gray-800 border border-gray-200"),children:[(0,r.jsx)("p",{className:"text-sm",children:e.text}),(0,r.jsx)("p",{className:"text-xs mt-1 ".concat(e.isOwn?"text-indigo-200":"text-gray-500"),children:(0,m.GP)(e.time,"HH:mm")})]})},e.id)),(0,r.jsx)("div",{ref:I})]}),(0,r.jsx)("div",{className:"bg-white border-t border-gray-200 p-4",children:(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)("input",{type:"text",placeholder:"Nhập tin nhắn...",value:w,onChange:e=>k(e.target.value),onKeyPress:e=>"Enter"===e.key&&L(),className:"flex-1 px-4 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"}),(0,r.jsx)("button",{onClick:L,className:"p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition",children:(0,r.jsx)(u.A,{className:"w-5 h-5"})})]})})]}):(0,r.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400",children:[(0,r.jsx)("div",{className:"w-24 h-24 bg-gray-200 border-2 border-dashed rounded-xl mb-4"}),(0,r.jsx)("p",{className:"text-lg",children:"Chọn một cuộc tr\xf2 chuyện để bắt đầu"}),(0,r.jsx)("p",{className:"text-sm mt-2",children:"Nhắn tin với chủ trọ ngay!"})]})}),F&&(0,r.jsx)("div",{className:"fixed inset-0 flex flex-col items-center justify-center bg-black/60 text-white z-50",children:"ringing"===O&&E?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{className:"text-xl mb-4",children:"\uD83D\uDCF2 C\xf3 cuộc gọi đến!"}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("button",{onClick:()=>{let{from:e,offer:s}=E;y(M),S(null),T("connected"),H(!0),navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{let r=new(j())({initiator:!1,trickle:!1,stream:t,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:relay1.expressturn.com:3478",username:"efree",credential:"efree"}]}});D.current=r,r.signal(s),r.on("signal",s=>{p.s.emit("answer-call",{to:e,answer:s})}),r.on("stream",e=>{let s=document.getElementById("remoteAudio");s&&(s.srcObject=e,s.play().catch(e=>console.error("⚠️ Audio play failed:",e)))})})},className:"bg-green-500 px-5 py-2 rounded-lg",children:"Chấp nhận"}),(0,r.jsx)("button",{onClick:()=>{let{from:e}=E;p.s.emit("reject-call",{to:e}),y(M),S(null),T("ended"),H(!1),b("/sounds/rejected.mp3")},className:"bg-red-500 px-5 py-2 rounded-lg",children:"Từ chối"})]})]}):"ringing"===O?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{className:"text-xl mb-4",children:"\uD83D\uDCDE Đang gọi..."}),(0,r.jsx)("button",{onClick:R,className:"bg-red-500 px-5 py-2 rounded-lg",children:"Hủy cuộc gọi"})]}):"connected"===O?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{className:"text-xl mb-4",children:"\uD83D\uDD0A Đang tr\xf2 chuyện"}),(0,r.jsx)("button",{onClick:R,className:"bg-red-500 px-5 py-2 rounded-lg",children:"Kết th\xfac"})]}):null}),(0,r.jsx)("audio",{src:"/sounds/ringing.mp3",preload:"auto",className:"hidden"}),(0,r.jsx)("audio",{src:"/sounds/end.mp3",preload:"auto",className:"hidden"}),(0,r.jsx)("audio",{src:"/sounds/incoming.mp3",preload:"auto",className:"hidden"}),(0,r.jsx)("audio",{src:"/sounds/rejected.mp3",preload:"auto",className:"hidden"})]})}},9838:()=>{}},e=>{e.O(0,[297,829,333,441,255,358],()=>e(e.s=6174)),_N_E=e.O()}]);